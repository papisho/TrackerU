
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - TrackerU</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .dashboard-header {
      background: linear-gradient(135deg, var(--primary), #0f172a);
      color: white;
      padding: var(--space-xl) 0;
      margin-bottom: var(--space-xl);
    }
    .dashboard-header h1 { color: white; margin-bottom: var(--space-sm); }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-xl);
    }
    .stat-card {
      background: white;
      padding: var(--space-lg);
      border-radius: var(--radius-lg);
      text-align: center;
      box-shadow: var(--shadow-md);
    }
    .stat-number {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: var(--space-sm);
    }
    .stat-label { color: var(--gray-600); font-size: var(--font-size-sm); }
    .sidebar-tabs {
      display: flex;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
      border-bottom: 2px solid var(--gray-200);
    }
    .tab-btn {
      background: none;
      border: none;
      padding: var(--space-md);
      border-bottom: 3px solid transparent;
      font-weight: 600;
      cursor: pointer;
      color: var(--gray-600);
      transition: var(--transition);
    }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-brand">
        <div class="navbar-brand-icon">âš½</div>
        <span>TrackerU</span>
      </div>
      <ul class="navbar-menu">
        <li><a href="index.html">Home</a></li>
        <li><a href="admin-dashboard.html" class="active">Dashboard</a></li>
        <li><a href="#" id="logoutLink" style="cursor: pointer;">Logout</a></li>
      </ul>
    </div>
  </nav>

  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div class="container">
      <h1>ðŸ‘‹ Welcome Coach!</h1>
      <p>Manage your players, metrics, and training content</p>
    </div>
  </div>

  <div class="container">
    <!-- Stats Section -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalPlayers">0</div>
        <div class="stat-label">Total Players</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="avgPerformance">0</div>
        <div class="stat-label">Avg Performance Level</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalVideos">0</div>
        <div class="stat-label">Videos Assigned</div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="sidebar-tabs">
      <button class="tab-btn active" data-tab="players-tab">ðŸ‘¥ Players</button>
      <button class="tab-btn" data-tab="add-player-tab">âž• Add Player</button>
    </div>

    <!-- Players Tab -->
    <div id="players-tab" class="tab-content active">
      <h2 style="margin-bottom: var(--space-lg);">Player Management</h2>
      <div id="playersList"></div>
    </div>

    <!-- Add Player Tab -->
    <div id="add-player-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Add New Player</h2>
        </div>
        <form id="addPlayerForm">
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">First Name</label>
              <input type="text" class="form-input" id="firstName" required>
            </div>
            <div class="form-group">
              <label class="form-label">Last Name</label>
              <input type="text" class="form-input" id="lastName" required>
            </div>
            <div class="form-group">
              <label class="form-label">Position</label>
              <input type="text" class="form-input" id="position" placeholder="e.g., Forward, Midfielder">
            </div>
            <div class="form-group">
              <label class="form-label">Jersey Number</label>
              <input type="number" class="form-input" id="jerseyNumber" min="1" max="99">
            </div>
            <div class="form-group">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-input" id="dateOfBirth">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Add Player</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Player Details Modal -->
  <div id="playerModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 95vh;">
      <div class="modal-header">
        <h2 id="modalPlayerName"></h2>
        <button class="modal-close" onclick="UI.closeModal('playerModal')">&times;</button>
      </div>
      <div id="playerDetails"></div>
    </div>
  </div>

  <!-- Supabase JS MUST load before app.js -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/app.js"></script>

  <script>
    const METRIC_CONFIG = {
      technical: {
        label: 'âš¡ Technical Skills',
        metrics: {
          ballControl: 'Receiving the ball (ball control)',
          ballStriking: 'Ball striking (short & long distance)',
          passing: 'Passing (short & long range)',
          duels: 'Ability to win 1v1 duels'
        }
      },
      mentality: {
        label: 'ðŸ§  Mentality',
        metrics: {
          emotionControl: 'Controls emotion',
          selfDevelopment: 'Takes charge of their own development',
          vocal: 'Vocal / communicates',
          performance: 'Performs well',
          focus: 'Maintains focus'
        }
      },
      intelligence: {
        label: 'ðŸŽ¯ Soccer Intelligence',
        metrics: {
          anticipation: 'Anticipates and reads the game',
          decisionMaking: 'Decision making',
          versatility: 'Versatility',
          spaceUsage: 'Use / creation of space'
        }
      },
      athleticism: {
        label: 'ðŸ’ª Athleticism',
        metrics: {
          agility: 'Agility',
          speed: 'Speed',
          stamina: 'Stamina'
        }
      }
    };

    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
    }

    function computeStats(players) {
      document.getElementById('totalPlayers').textContent = players.length;

      let totalVideos = 0;
      let totalPerformance = 0;
      let metricCount = 0;

      players.forEach(p => {
        totalVideos += Array.isArray(p.assignedVideos) ? p.assignedVideos.length : 0;
        if (p.metrics) {
          Object.values(p.metrics).forEach(category => {
            Object.values(category || {}).forEach(metric => {
              if (metric && typeof metric.level === 'number') {
                totalPerformance += metric.level;
                metricCount++;
              }
            });
          });
        }
      });

      document.getElementById('totalVideos').textContent = totalVideos;
      document.getElementById('avgPerformance').textContent = metricCount > 0 ? Math.round(totalPerformance / metricCount) : 0;
    }

    function renderPlayers() {
      const players = DataManager.getPlayers();
      const playersList = document.getElementById('playersList');

      computeStats(players);

      playersList.innerHTML = '';
      if (!players.length) {
        playersList.innerHTML = '<p style="text-align:center;color:var(--gray-500);padding:var(--space-xl);">No players added yet. Add your first player to get started!</p>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'grid grid-2';

      players.forEach(player => {
        let totalMetrics = 0;
        let metricsSum = 0;

        if (player.metrics) {
          Object.values(player.metrics).forEach(category => {
            Object.values(category || {}).forEach(metric => {
              if (metric && typeof metric.level === 'number') {
                metricsSum += metric.level;
                totalMetrics++;
              }
            });
          });
        }

        const avgLevel = totalMetrics > 0 ? Math.round(metricsSum / totalMetrics) : 0;

        const card = document.createElement('div');
        card.className = 'card';

        card.innerHTML = `
          <div class="card-header">
            <div style="display:flex;justify-content:space-between;align-items:start;">
              <div>
                <h3 class="card-title" style="margin:0;">${player.firstName || ''} ${player.lastName || ''}</h3>
                <p style="color:var(--gray-500);font-size:var(--font-size-sm);margin:0;">
                  ${player.position || ''} ${player.jerseyNumber ? 'Â· #' + player.jerseyNumber : ''}
                </p>
              </div>
              <span class="badge badge-success">${player.code || ''}</span>
            </div>
          </div>
          <div class="card-body">
            <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-md);">
              <div>
                <p style="font-size:var(--font-size-sm);color:var(--gray-600);margin:0;">Avg Performance</p>
                <p style="font-size:20px;font-weight:700;color:var(--primary);margin:0;">${avgLevel}/10</p>
              </div>
              <div>
                <p style="font-size:var(--font-size-sm);color:var(--gray-600);margin:0;">Videos</p>
                <p style="font-size:20px;font-weight:700;color:var(--secondary);margin:0;">${Array.isArray(player.assignedVideos) ? player.assignedVideos.length : 0}</p>
              </div>
            </div>
          </div>
          <div class="card-footer" style="padding:var(--space-md) 0;gap:var(--space-sm);">
            <button class="btn btn-primary btn-sm" data-action="edit" data-id="${player.id}">Edit</button>
            <button class="btn btn-outline btn-sm" data-action="view" data-id="${player.id}">View Profile</button>
            <button class="btn btn-danger btn-sm" data-action="delete" data-id="${player.id}">Delete</button>
          </div>
        `;

        grid.appendChild(card);
      });

      playersList.appendChild(grid);
    }

    function getDefaultMetrics() {
      const metrics = {};
      Object.entries(METRIC_CONFIG).forEach(([catKey, catCfg]) => {
        metrics[catKey] = {};
        Object.keys(catCfg.metrics).forEach(metricKey => {
          metrics[catKey][metricKey] = { level: 5, comment: '' };
        });
      });
      return metrics;
    }

    function viewPlayer(playerId) {
      const player = DataManager.getPlayerById(playerId);
      if (!player) return;

      document.getElementById('modalPlayerName').textContent = `${player.firstName || ''} ${player.lastName || ''}`;

      let html = `
        <div style="margin-bottom: var(--space-lg);">
          <p><strong>Position:</strong> ${player.position || '-'}</p>
          <p><strong>Jersey #:</strong> ${player.jerseyNumber || '-'}</p>
          <p><strong>Date of Birth:</strong> ${UI.formatDate(player.dateOfBirth)}</p>
          <p><strong>Player Code:</strong> <span style="background-color: var(--primary-light); padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); font-weight: 600; color: var(--primary);">${player.code || ''}</span></p>
        </div>

        <h4 style="border-bottom:2px solid var(--gray-200);padding-bottom:var(--space-md);margin-bottom:var(--space-md);">Performance Metrics</h4>
      `;

      Object.entries(METRIC_CONFIG).forEach(([catKey, catCfg]) => {
        html += `<div style="background-color: var(--gray-50); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md);">
          <h5 style="margin-bottom: var(--space-md);">${catCfg.label}</h5>`;

        const category = (player.metrics && player.metrics[catKey]) ? player.metrics[catKey] : {};

        Object.entries(catCfg.metrics).forEach(([metricKey, label]) => {
          const metric = category[metricKey] || { level: 0, comment: '' };
          const color = UI.getMetricRatingColor(metric.level || 0);
          html += `
            <div style="margin-bottom: var(--space-md);">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-sm);">
                <span style="font-weight:500;">${label}</span>
                <span style="background-color:${color};color:white;padding:2px 8px;border-radius:var(--radius-sm);font-weight:600;font-size:var(--font-size-sm);">${metric.level || 0}/10</span>
              </div>
              <p style="margin:0;font-size:var(--font-size-sm);color:var(--gray-600);">${metric.comment || ''}</p>
            </div>
          `;
        });

        html += `</div>`;
      });

      // Videos
      html += `<h4 style="border-bottom:2px solid var(--gray-200);padding-bottom:var(--space-md);margin:var(--space-lg) 0 var(--space-md);">Assigned Videos</h4>`;

      if (Array.isArray(player.assignedVideos) && player.assignedVideos.length) {
        player.assignedVideos.forEach(v => {
          html += `
            <div style="background-color: var(--gray-50); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md); display:flex; justify-content:space-between; align-items:center;">
              <div>
                <p style="font-weight:600;margin:0;">${v.title || ''}</p>
                <p style="font-size:var(--font-size-sm);color:var(--gray-500);margin:0;">Assigned: ${UI.formatDate(v.assignedDate)}</p>
              </div>
              <button class="btn btn-danger btn-sm" onclick="removeVideo('${player.id}', '${v.id}')">Remove</button>
            </div>
          `;
        });
      } else {
        html += '<p style="color: var(--gray-500); font-style: italic;">No videos assigned yet.</p>';
      }

      // AI Summary
      const aiSummary = AI.generatePlayerSummary(player);
      html += `
        <div style="margin-top: var(--space-xl); padding: var(--space-lg); border-radius: var(--radius-lg); background: var(--gray-50); border-left: 4px solid var(--primary);">
          <h4 style="margin-bottom: var(--space-md);">AI Development Summary (beta)</h4>
          <p style="margin-bottom: var(--space-sm);">${aiSummary.overallText}</p>
          <p style="margin-bottom: var(--space-xs);"><strong>Strengths:</strong> ${aiSummary.strengthsText}</p>
          <p><strong>Focus areas:</strong> ${aiSummary.focusText}</p>
        </div>
      `;

      html += `
        <div style="margin-top: var(--space-lg); display:flex; gap: var(--space-md);">
          <button class="btn btn-secondary" onclick="openVideoModal('${player.id}')">Assign Video</button>
        </div>
      `;

      document.getElementById('playerDetails').innerHTML = html;
      UI.openModal('playerModal');
    }

    function editPlayer(playerId) {
      const player = DataManager.getPlayerById(playerId);
      if (!player) return;

      document.getElementById('modalPlayerName').textContent = `Edit: ${player.firstName || ''} ${player.lastName || ''}`;

      let html = `
        <form id="editPlayerForm">
          <div style="margin-bottom: var(--space-lg); display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: var(--space-md);">
            <div class="form-group">
              <label class="form-label">First Name</label>
              <input type="text" class="form-input" name="firstName" value="${player.firstName || ''}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Last Name</label>
              <input type="text" class="form-input" name="lastName" value="${player.lastName || ''}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Position</label>
              <input type="text" class="form-input" name="position" value="${player.position || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Jersey Number</label>
              <input type="number" class="form-input" name="jerseyNumber" value="${player.jerseyNumber || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-input" name="dateOfBirth" value="${player.dateOfBirth || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Player Code (read-only)</label>
              <input type="text" class="form-input" value="${player.code || ''}" disabled>
            </div>
          </div>

          <h4 style="border-bottom: 2px solid var(--gray-200); padding-bottom: var(--space-md); margin-bottom: var(--space-md);">
            Performance Metrics (1â€“10) & Comments
          </h4>
      `;

      Object.entries(METRIC_CONFIG).forEach(([catKey, catCfg]) => {
        const playerCat = (player.metrics && player.metrics[catKey]) ? player.metrics[catKey] : {};
        html += `<div style="background-color: var(--gray-50); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
          <h5 style="margin-bottom: var(--space-md);">${catCfg.label}</h5>`;

        Object.entries(catCfg.metrics).forEach(([metricKey, metricLabel]) => {
          const current = playerCat[metricKey] || {};
          const lvl = (typeof current.level === 'number') ? current.level : 5;
          const cmt = current.comment || '';
          html += `
            <div class="form-group" style="margin-bottom: var(--space-md);">
              <label class="form-label">${metricLabel}</label>
              <div style="display:flex;align-items:center;gap:var(--space-md);margin-bottom:var(--space-xs);">
                <input type="number" class="form-input" name="level-${catKey}-${metricKey}" min="1" max="10" value="${lvl}" style="max-width: 90px;" required>
                <span style="font-size: var(--font-size-sm); color: var(--gray-600);">1 = needs lots of work, 10 = elite</span>
              </div>
              <textarea class="form-input" name="comment-${catKey}-${metricKey}" rows="2" placeholder="Coach comment for this area...">${cmt}</textarea>
            </div>
          `;
        });

        html += `</div>`;
      });

      html += `
          <div style="margin-top: var(--space-lg); display:flex; gap: var(--space-md); justify-content:flex-end;">
            <button type="button" class="btn btn-outline" onclick="UI.closeModal('playerModal')">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      `;

      document.getElementById('playerDetails').innerHTML = html;
      UI.openModal('playerModal');

      document.getElementById('editPlayerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const form = e.target;
        const updatedMetrics = {};

        Object.entries(METRIC_CONFIG).forEach(([catKey, catCfg]) => {
          updatedMetrics[catKey] = {};
          Object.keys(catCfg.metrics).forEach(metricKey => {
            const levelInput = form.querySelector(`[name="level-${catKey}-${metricKey}"]`);
            const commentInput = form.querySelector(`[name="comment-${catKey}-${metricKey}"]`);
            let level = parseInt(levelInput.value, 10);
            if (Number.isNaN(level)) level = 5;
            if (level < 1) level = 1;
            if (level > 10) level = 10;

            updatedMetrics[catKey][metricKey] = {
              level,
              comment: (commentInput.value || '').trim()
            };
          });
        });

        const updatedData = {
          firstName: (form.firstName.value || '').trim(),
          lastName: (form.lastName.value || '').trim(),
          position: (form.position.value || '').trim(),
          jerseyNumber: form.jerseyNumber.value ? parseInt(form.jerseyNumber.value, 10) : null,
          dateOfBirth: form.dateOfBirth.value || null,
          metrics: updatedMetrics
        };

        try {
          await DataManager.updatePlayer(playerId, updatedData);
          UI.showAlert('Player updated successfully', 'success');
          await DataManager.init(true);
          renderPlayers();
          UI.closeModal('playerModal');
        } catch (err) {
          UI.showAlert(err.message || 'Failed to update player', 'danger');
        }
      }, { once: true });
    }

    async function deletePlayer(playerId) {
      if (!confirm('Are you sure you want to delete this player? This action cannot be undone.')) return;
      try {
        await DataManager.deletePlayer(playerId);
        UI.showAlert('Player deleted successfully', 'success');
        await DataManager.init(true);
        renderPlayers();
      } catch (err) {
        UI.showAlert(err.message || 'Failed to delete player', 'danger');
      }
    }

    async function openVideoModal(playerId) {
      const title = prompt('Video Title:');
      if (!title) return;
      const url = prompt('Video URL (YouTube embed URL):');
      if (!url) return;

      try {
        await DataManager.addVideo(playerId, { title, url });
        UI.showAlert('Video assigned successfully', 'success');
        await DataManager.init(true);
        renderPlayers();
        viewPlayer(playerId);
      } catch (err) {
        UI.showAlert(err.message || 'Failed to assign video', 'danger');
      }
    }

    async function removeVideo(playerId, videoId) {
      if (!confirm('Are you sure you want to remove this video?')) return;
      try {
        await DataManager.removeVideo(playerId, videoId);
        UI.showAlert('Video removed', 'success');
        await DataManager.init(true);
        renderPlayers();
        viewPlayer(playerId);
      } catch (err) {
        UI.showAlert(err.message || 'Failed to remove video', 'danger');
      }
    }

    // Expose for inline handlers (modal buttons)
    window.openVideoModal = openVideoModal;
    window.removeVideo = removeVideo;

    document.addEventListener('DOMContentLoaded', async () => {
      // Auth gate
      const ok = await Auth.checkAdminAuth();
      if (!ok) return;

      // Tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab')));
      });

      // Logout
      document.getElementById('logoutLink').addEventListener('click', async (e) => {
        e.preventDefault();
        await Auth.logoutAdmin();
        window.location.href = 'index.html';
      });

      // Initial load
      await DataManager.init(true);
      renderPlayers();

      // Click handlers for player cards
      document.getElementById('playersList').addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        if (action === 'view') viewPlayer(id);
        if (action === 'edit') editPlayer(id);
        if (action === 'delete') deletePlayer(id);
      });

      // Add player
      document.getElementById('addPlayerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        try {
          const player = await DataManager.addPlayer({
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            position: document.getElementById('position').value.trim(),
            jerseyNumber: document.getElementById('jerseyNumber').value ? parseInt(document.getElementById('jerseyNumber').value, 10) : null,
            dateOfBirth: document.getElementById('dateOfBirth').value || null,
            metrics: getDefaultMetrics(),
            assignedVideos: []
          });

          UI.showAlert(`Player added. Code: ${player.code}`, 'success');
          e.target.reset();
          await DataManager.init(true);
          renderPlayers();
          switchTab('players-tab');
        } catch (err) {
          UI.showAlert(err.message || 'Failed to add player', 'danger');
        }
      });
    });
  </script>
</body>
</html>
