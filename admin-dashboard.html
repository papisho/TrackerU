<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - TrackerU</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/analytics.css">
    <link rel="stylesheet" href="css/rewards.css">
    <style>
    .dashboard-header {
      background: linear-gradient(135deg, var(--primary), #0f172a);
      color: white;
      padding: var(--space-xl) 0;
      margin-bottom: var(--space-xl);
    }
    .dashboard-header h1 { color: white; margin-bottom: var(--space-sm); }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-lg);
      margin-bottom: var(--space-xl);
    }
    .stat-card {
      background: white;
      padding: var(--space-lg);
      border-radius: var(--radius-lg);
      text-align: center;
      box-shadow: var(--shadow-md);
    }
    .stat-number {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: var(--space-sm);
    }
    .stat-label { color: var(--gray-600); font-size: var(--font-size-sm); }
    .sidebar-tabs {
      display: flex;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
      border-bottom: 2px solid var(--gray-200);
      flex-wrap: wrap;
    }
    .tab-btn {
      background: none;
      border: none;
      padding: var(--space-md);
      border-bottom: 3px solid transparent;
      font-weight: 600;
      cursor: pointer;
      color: var(--gray-600);
      transition: var(--transition);
    }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .rating-context-section {
      background: var(--gray-50);
      padding: var(--space-lg);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-xl);
      border-left: 4px solid var(--primary);
    }

    .context-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: var(--space-md);
    }

    .player-rank-list {
      display: grid;
      gap: var(--space-md);
    }

    .player-rank-item {
      background: white;
      padding: var(--space-lg);
      border-radius: var(--radius-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-sm);
      border-left: 4px solid var(--primary);
      transition: var(--transition);
    }

    .player-rank-item:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .player-rank-item.top { border-left-color: #2ecc71; }
    .player-rank-item.attention { border-left-color: #e74c3c; }
    .player-rank-item.improved { border-left-color: #3498db; }

    .player-selector {
      background: white;
      padding: var(--space-xl);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-xl);
    }

    .player-selector label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--space-sm);
      color: var(--gray-700);
    }

    .player-selector select {
      width: 100%;
      padding: var(--space-md);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .player-selector select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    @media (max-width: 768px) {
      .context-grid { grid-template-columns: 1fr; }
    }
  </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="navbar-container">
        <div class="navbar-brand">
          <div class="navbar-brand-icon">‚öΩ</div>
          <span>TrackerU</span>
        </div>
        <ul class="navbar-menu">
          <li><a href="index.html">Home</a></li>
          <li><a href="admin-dashboard.html" class="active">Dashboard</a></li>
          <li><a href="rewards-leaderboard.html">Leaderboard</a></li>
          <li><a href="#" id="logoutLink"
              style="cursor: pointer;">Logout</a></li>
        </ul>
      </div>
    </nav>

    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div class="container">
        <h1>üëã Welcome Coach!</h1>
        <p>Manage your players, metrics, attendance, and rewards</p>
      </div>
    </div>

    <div class="container">
      <!-- Stats Section -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalPlayers">0</div>
          <div class="stat-label">Total Players</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgPerformance">0</div>
          <div class="stat-label">Avg Performance Level</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalVideos">0</div>
          <div class="stat-label">Videos Assigned</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="improvingPlayers">0</div>
          <div class="stat-label">Players Improving</div>
        </div>
        <div class="stat-card"
          style="background: linear-gradient(135deg, #ffd700, #ffa500); color: white;">
          <div class="stat-number" style="color: white;"
            id="totalPoints">0</div>
          <div class="stat-label" style="color: rgba(255,255,255,0.9);">Team
            Points</div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="sidebar-tabs">
        <button class="tab-btn active" data-tab="players-tab">üë•
          Players</button>
        <button class="tab-btn" data-tab="attendance-tab">‚úÖ Attendance</button>
        <button class="tab-btn" data-tab="rewards-tab">üéØ Rewards
          Settings</button>
        <button class="tab-btn" data-tab="team-analytics-tab">üìä Team
          Analytics</button>
        <button class="tab-btn" data-tab="add-player-tab">‚ûï Add Player</button>
      </div>

      <!-- Players Tab -->
      <div id="players-tab" class="tab-content active">
        <h2 style="margin-bottom: var(--space-lg);">Player Management</h2>
        <div id="playersList"></div>
      </div>

      <!-- Attendance Tab -->
      <div id="attendance-tab" class="tab-content">
        <div class="attendance-calendar">
          <div class="attendance-header">
            <h2>‚úÖ Take Attendance</h2>
            <div class="attendance-controls">
              <input type="date" id="attendanceDate" class="form-input"
                style="width: auto;">
              <select id="sessionType" class="form-select" style="width: auto;">
                <option value="training">Training Session</option>
                <option value="game">Game/Match</option>
                <option value="scrimmage">Scrimmage</option>
                <option value="conditioning">Conditioning</option>
              </select>
              <button class="btn btn-success" onclick="saveAttendance()">üíæ Save
                Attendance</button>
            </div>
          </div>
          <div class="attendance-grid" id="attendanceGrid"></div>
        </div>

        <!-- Attendance History -->
        <div class="metric-section" style="margin-top: var(--space-xl);">
          <details>
            <summary style="font-size: 1.25rem; font-weight: 700; cursor: pointer; margin-bottom: var(--space-lg); outline: none;">
              üìÖ Recent Sessions <span style="font-size: 0.8rem; color: var(--gray-600); font-weight: normal; margin-left: 10px;">(Click to View/Hide)</span>
            </summary>
            <div id="attendanceHistory"></div>
          </details>
        </div>

      <!-- Rewards Settings Tab -->
      </div> <div id="rewards-tab" class="tab-content">
        <div class="rewards-settings">
          <h2 style="margin-bottom: var(--space-lg);">üéØ Rewards System
            Settings</h2>
            

          <!-- Toggle Rewards -->
          <div class="rewards-toggle">
            <div>
              <h4 style="margin-bottom: var(--space-xs);">Enable Physical
                Rewards</h4>
              <p
                style="color: var(--gray-600); font-size: var(--font-size-sm); margin: 0;">Turn
                off if you can't afford physical rewards. Badges will always be
                visible.</p>
            </div>
            <div class="toggle-switch" id="rewardsToggle"
              onclick="toggleRewards()">
            </div>
          </div>

          <!-- Custom Rewards List -->
          <div style="margin-top: var(--space-xl);">
            <div
              style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
              <h3>Custom Rewards</h3>
              <button class="btn btn-primary" onclick="addCustomReward()">+ Add
                Reward</button>
            </div>
            <div class="custom-rewards-list" id="customRewardsList"></div>
          </div>
        </div>
      </div>

      <!-- Team Analytics Tab -->
      <div id="team-analytics-tab" class="tab-content">
        <h2 style="margin-bottom: var(--space-lg);">üìä Team Analytics &
          Insights</h2>

        <!-- Player Selector -->
        <div class="player-selector">
          <label for="playerAnalyticsSelect">üîç View Detailed Player
            Analytics</label>
          <select id="playerAnalyticsSelect"
            onchange="loadPlayerAnalytics(this.value)">
            <option value>-- Select a player --</option>
          </select>
        </div>

        <!-- Player Analytics Container -->
        <div id="playerAnalyticsContainer" style="display: none;"></div>

        <!-- Team Analytics Container -->
        <div id="teamAnalyticsContainer"></div>
      </div>

      <!-- Add Player Tab -->
      <div id="add-player-tab" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Add New Player</h2>
          </div>
          <form id="addPlayerForm">
            <div class="grid grid-2">
              <div class="form-group">
                <label class="form-label">First Name</label>
                <input type="text" class="form-input" id="firstName" required>
              </div>
              <div class="form-group">
                <label class="form-label">Last Name</label>
                <input type="text" class="form-input" id="lastName" required>
              </div>
              <div class="form-group">
                <label class="form-label">Position</label>
                <input type="text" class="form-input" id="position"
                  placeholder="e.g., Forward, Midfielder">
              </div>
              <div class="form-group">
                <label class="form-label">Jersey Number</label>
                <input type="number" class="form-input" id="jerseyNumber"
                  min="1" max="99">
              </div>
              <div class="form-group">
                <label class="form-label">Date of Birth</label>
                <input type="date" class="form-input" id="dateOfBirth">
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Add Player</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Player Details Modal -->
    <div id="playerModal" class="modal">
      <div class="modal-content" style="max-width: 900px; max-height: 95vh;">
        <div class="modal-header">
          <h2 id="modalPlayerName"></h2>
          <button class="modal-close"
            onclick="UI.closeModal('playerModal')">&times;</button>
        </div>
        <div id="playerDetails"></div>
      </div>
    </div>

    <!-- Supabase JS MUST load before app.js -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <script src="js/app.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/rewards.js"></script>

    <script>
    const METRIC_CONFIG = {
      technical: {
        label: '‚ö° Technical Skills',
        metrics: {
          ballControl: 'Receiving the ball (ball control)',
          ballStriking: 'Ball striking (short & long distance)',
          passing: 'Passing (short & long range)',
          duels: 'Ability to win 1v1 duels'
        }
      },
      mentality: {
        label: 'üß† Mentality',
        metrics: {
          emotionControl: 'Controls emotion',
          selfDevelopment: 'Takes charge of their own development',
          vocal: 'Vocal / communicates',
          performance: 'Performs well',
          focus: 'Maintains focus'
        }
      },
      intelligence: {
        label: 'üéØ Soccer Intelligence',
        metrics: {
          anticipation: 'Anticipates and reads the game',
          decisionMaking: 'Decision making',
          versatility: 'Versatility',
          spaceUsage: 'Use / creation of space'
        }
      },
      athleticism: {
        label: 'üí™ Athleticism',
        metrics: {
          agility: 'Agility',
          speed: 'Speed',
          stamina: 'Stamina'
        }
      }
    };

    let teamAnalyticsCharts = [];
    let playerAnalyticsCharts = [];
    let attendanceState = {};
    let teamSettings = { rewardsEnabled: true, customRewards: [] };

    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');

      if (tabId === 'team-analytics-tab') {
        populatePlayerDropdown();
        loadTeamAnalytics();
      } else if (tabId === 'attendance-tab') {
        loadAttendanceTab();
      } else if (tabId === 'rewards-tab') {
        loadRewardsSettings();
      }
    }

    function loadAttendanceTab() {
      // Set today's date
      document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
      
      const players = DataManager.getPlayers();
      const grid = document.getElementById('attendanceGrid');
      grid.innerHTML = '';

      // Initialize attendance state
      attendanceState = {};
      players.forEach(player => {
        attendanceState[player.id] = { status: null, absenceReason: 'other' };

      });

      players.forEach(player => {
  const card = document.createElement('div');
  card.className = 'attendance-player-card';
  card.id = `attendance-${player.id}`;

  card.innerHTML = `
    <div class="attendance-player-name">${player.firstName} ${player.lastName}</div>

    <div class="attendance-toggle">
      <button class="attendance-btn present" onclick="markAttendance('${player.id}', true)">Present</button>
      <button class="attendance-btn absent" onclick="markAttendance('${player.id}', false)">Absent</button>
    </div>

    <!-- Only shown when Absent is selected -->
    <div class="absence-reason" style="display:none;">
      <select onchange="setAbsenceReason('${player.id}', this.value)">
        <option value="excused">Excused</option>
        <option value="other" selected>Other</option>
      </select>
    </div>
  `;

  grid.appendChild(card);
});
    }


  function markAttendance(playerId, isPresent) {
  // Ensure object state exists
  if (!attendanceState[playerId] || typeof attendanceState[playerId] !== 'object') {
    attendanceState[playerId] = { status: null, absenceReason: 'other' };
  }

  attendanceState[playerId].status = isPresent;

  const card = document.getElementById(`attendance-${playerId}`);
  card.className = 'attendance-player-card ' + (isPresent ? 'present' : 'absent');

  const buttons = card.querySelectorAll('.attendance-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  buttons[isPresent ? 0 : 1].classList.add('active');

  // Show/hide absence reason dropdown
  const reasonWrap = card.querySelector('.absence-reason');
  if (reasonWrap) {
    reasonWrap.style.display = isPresent ? 'none' : 'block';
  }
}

  function setAbsenceReason(playerId, reason) {
  if (!attendanceState[playerId] || typeof attendanceState[playerId] !== 'object') {
    attendanceState[playerId] = { status: null, absenceReason: 'other' };
  }
  attendanceState[playerId].absenceReason = (reason === 'excused') ? 'excused' : 'other';
}

async function saveAttendance() {
  const date = document.getElementById('attendanceDate').value;
  const sessionType = document.getElementById('sessionType').value;

  if (!date) {
    UI.showAlert('Please select a date', 'danger');
    return;
  }

  const unmarked = Object.values(attendanceState).filter(v => v?.status === null).length;
  if (unmarked > 0) {
    if (!confirm(`${unmarked} players are unmarked. Continue?`)) return;
  }

  try {
    const players = DataManager.getPlayers();

    for (const player of players) {
      const st = attendanceState[player.id];
      const isPresent = st ? st.status : null;

      if (isPresent !== null) {
        const absenceReason = st?.absenceReason || 'other';

        // IMPORTANT: pass player object (not id) so rewards.attendanceHistory exists
        const updated = Rewards.recordAttendance(player, date, isPresent, sessionType, absenceReason);

        // Persist rewards (attendance + points) to Supabase
        await DataManager.updatePlayer(player.id, { rewards: updated.rewards });
      }
    }

    UI.showAlert('Attendance saved successfully!', 'success');
    // Refresh data from Supabase
    await DataManager.init(true);

    // Refresh UI tabs
    loadAttendanceHistory();
    
    computeStats(DataManager.getPlayers());
  } catch (err) {
    UI.showAlert(err.message || 'Failed to save attendance', 'danger');
  }
}


    // --- NEW: Attendance History with Collapsible Items, Filters, and Delete ---

    let attendanceHistoryFilterDate = '';

    function loadAttendanceHistory() {
      const container = document.getElementById('attendanceHistory');
      const players = DataManager.getPlayers();

      // 1. Gather all unique sessions
      const sessions = {};
      players.forEach(player => {
        const rewards = player.rewards || {};
        if (rewards.attendanceHistory && Array.isArray(rewards.attendanceHistory)) {
          rewards.attendanceHistory.forEach(record => {
            const key = `${record.date}-${record.sessionType || 'training'}`;
            if (!sessions[key]) {
              sessions[key] = {
                date: record.date,
                sessionType: record.sessionType || 'training',
                present: [],
                absent: [],
                timestamp: new Date(record.date).getTime()
              };
            }
            if (record.present === true) {
              sessions[key].present.push(`${player.firstName} ${player.lastName}`);
            } else {
              sessions[key].absent.push(`${player.firstName} ${player.lastName}`);
            }
          });
        }
      });

      // 2. Convert to array and sort (Newest First)
      let sortedSessions = Object.values(sessions).sort((a, b) => b.timestamp - a.timestamp);

      // 3. Apply Date Filter if set
      if (attendanceHistoryFilterDate) {
        sortedSessions = sortedSessions.filter(s => s.date === attendanceHistoryFilterDate);
      }

      // 4. Build UI
      if (sortedSessions.length === 0) {
        container.innerHTML = `
           <div style="margin-bottom: var(--space-md); display: flex; gap: var(--space-sm);">
              <input type="date" class="form-input" style="width: auto;" onchange="filterHistoryByDate(this.value)" value="${attendanceHistoryFilterDate}">
              ${attendanceHistoryFilterDate ? '<button class="btn btn-outline" onclick="filterHistoryByDate(\'\')">Clear Filter</button>' : ''}
           </div>
           <p style="text-align: center; color: var(--gray-500); padding: var(--space-xl);">No attendance records found.</p>
        `;
        return;
      }

      // Header with Filter and "Delete All" Danger Button
      let html = `
        <div style="margin-bottom: var(--space-lg); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
          <div style="display: flex; gap: var(--space-sm); align-items: center;">
             <label style="font-weight: 600; color: var(--gray-700);">Filter by Date:</label>
             <input type="date" class="form-input" style="width: auto; padding: 6px;" onchange="filterHistoryByDate(this.value)" value="${attendanceHistoryFilterDate}">
             ${attendanceHistoryFilterDate ? '<button class="btn btn-outline btn-sm" onclick="filterHistoryByDate(\'\')">Clear</button>' : ''}
          </div>
          <button class="btn btn-danger btn-sm" onclick="clearAllAttendanceHistory()">üóëÔ∏è Delete Entire History</button>
        </div>
      `;

      sortedSessions.forEach(session => {
        // We use <details> for native collapsible behavior
        html += `
          <details style="background: white; border-radius: var(--radius-md); margin-bottom: var(--space-md); box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200); overflow: hidden;">
            <summary style="padding: var(--space-md); cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--gray-50); list-style: none;">
              <div style="display: flex; align-items: center; gap: var(--space-md);">
                <span style="font-size: 1.2em;">üëâ</span>
                <div>
                  <strong style="font-size: var(--font-size-lg); display: block;">${UI.formatDate(session.date)}</strong>
                  <span style="color: var(--gray-600); text-transform: capitalize; font-size: var(--font-size-sm);">${session.sessionType}</span>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: var(--space-md);">
                <div style="text-align: right;">
                  <span style="color: var(--success); font-weight: 700; display: block;">${session.present.length} Present</span>
                  <span style="color: var(--danger); font-size: var(--font-size-sm);">${session.absent.length} Absent</span>
                </div>
                <span style="font-size: 0.8em; color: var(--gray-400);">‚ñº</span>
              </div>
            </summary>
            
            <div style="padding: var(--space-lg); border-top: 1px solid var(--gray-200);">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); margin-bottom: var(--space-lg);">
                <div>
                   <h5 style="color: var(--success); margin-bottom: var(--space-sm);">‚úÖ Present</h5>
                   ${session.present.length ? `<ul style="margin: 0; padding-left: 20px;">${session.present.map(n => `<li>${n}</li>`).join('')}</ul>` : '<span style="color: var(--gray-500); font-style: italic;">None</span>'}
                </div>
                <div>
                   <h5 style="color: var(--danger); margin-bottom: var(--space-sm);">‚ùå Absent</h5>
                   ${session.absent.length ? `<ul style="margin: 0; padding-left: 20px;">${session.absent.map(n => `<li>${n}</li>`).join('')}</ul>` : '<span style="color: var(--gray-500); font-style: italic;">None</span>'}
                </div>
              </div>
              
              <div style="text-align: right; border-top: 1px solid var(--gray-100); padding-top: var(--space-md);">
                 <button class="btn btn-danger btn-sm" onclick="deleteSession('${session.date}', '${session.sessionType}')">Delete this Session</button>
              </div>
            </div>
          </details>
        `;
      });

      container.innerHTML = html;
    }

    // Helper: Filter by date
    window.filterHistoryByDate = function(date) {
      attendanceHistoryFilterDate = date;
      loadAttendanceHistory();
    }

    // Helper: Delete a specific session (iterates through all players)
    window.deleteSession = async function(date, sessionType) {
      if (!confirm(`Are you sure you want to delete the ${sessionType} session on ${UI.formatDate(date)}? This will remove the record for ALL players.`)) return;

      try {
        const players = DataManager.getPlayers();
        let updateCount = 0;

        for (const player of players) {
          // Remove from local object
          const updatedPlayer = Rewards.removeAttendanceRecord(player, date, sessionType);
          
          // Save to Supabase
          // Optimization: Only update if the history length actually changed or we suspect a change
          if (updatedPlayer) {
             await DataManager.updatePlayer(player.id, { rewards: updatedPlayer.rewards });
             updateCount++;
          }
        }

        UI.showAlert(`Deleted session. Updated records for ${updateCount} players.`, 'success');
        await DataManager.init(true);
        loadAttendanceHistory();
        computeStats(DataManager.getPlayers()); // Refresh dashboard stats
      } catch (err) {
        UI.showAlert('Error deleting session: ' + err.message, 'danger');
      }
    }

    // Helper: Delete ENTIRE history
    window.clearAllAttendanceHistory = async function() {
      const confirm1 = confirm("‚ö†Ô∏è DANGER ZONE ‚ö†Ô∏è\n\nThis will delete EVERY attendance record for EVERY player.\n\nAre you absolutely sure?");
      if (!confirm1) return;
      
      const confirm2 = confirm("Final Confirmation: This cannot be undone. Delete all attendance history?");
      if (!confirm2) return;

      try {
        const players = DataManager.getPlayers();
        for (const player of players) {
          if (player.rewards) {
             player.rewards.attendanceHistory = [];
             // Reset streak
             player.rewards.currentStreak = 0;
             player.rewards.longestStreak = 0; // Optional: keep longest streak or reset? Usually reset if history is gone.
             await DataManager.updatePlayer(player.id, { rewards: player.rewards });
          }
        }
        UI.showAlert('All attendance history has been wiped.', 'success');
        await DataManager.init(true);
        loadAttendanceHistory();
        computeStats(DataManager.getPlayers());
      } catch (err) {
        UI.showAlert('Error clearing history: ' + err.message, 'danger');
      }
    }

    async function loadRewardsSettings() {
      // FIX: Load from Supabase, not LocalStorage
      try {
        const settings = await DataManager.getTeamSettings();
        teamSettings = settings;

        // Update toggle UI
        const toggle = document.getElementById('rewardsToggle');
        toggle.className = teamSettings.rewardsEnabled ? 'toggle-switch active' : 'toggle-switch';

        renderCustomRewards();
      } catch (err) {
        console.error("Failed to load settings", err);
      }
    }

    async function toggleRewards() {
      teamSettings.rewardsEnabled = !teamSettings.rewardsEnabled;
      
      // FIX: Save to Supabase
      try {
        await DataManager.updateTeamSettings(teamSettings);
        loadRewardsSettings(); // Refresh UI
        UI.showAlert(`Rewards ${teamSettings.rewardsEnabled ? 'enabled' : 'disabled'}`, 'success');
      } catch (err) {
        UI.showAlert('Failed to save settings', 'danger');
      }
    }

    async function addCustomReward() {
      const name = prompt('Reward Name (e.g., "Pizza Party"):');
      if (!name) return;
      const cost = prompt('Points Cost (e.g., 500):');
      if (!cost) return;
      const description = prompt('Description (optional):');

      teamSettings.customRewards.push({
        id: Date.now().toString(),
        name,
        cost: parseInt(cost, 10),
        description: description || ''
      });

      // FIX: Save to Supabase
      try {
        await DataManager.updateTeamSettings(teamSettings);
        renderCustomRewards();
        UI.showAlert('Reward added', 'success');
      } catch (err) {
        UI.showAlert('Failed to save reward', 'danger');
      }
    }

    async function removeCustomReward(rewardId) {
      if (!confirm('Remove this reward?')) return;
      
      teamSettings.customRewards = teamSettings.customRewards.filter(r => r.id !== rewardId);
      
      // FIX: Save to Supabase
      try {
        await DataManager.updateTeamSettings(teamSettings);
        renderCustomRewards();
        UI.showAlert('Reward removed', 'success');
      } catch (err) {
        UI.showAlert('Failed to remove reward', 'danger');
      }
    }


    function renderCustomRewards() {
      const container = document.getElementById('customRewardsList');
      if (teamSettings.customRewards.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: var(--space-xl); font-style: italic;">No custom rewards yet. Click "Add Reward" to create one.</p>';
        return;
      }

      container.innerHTML = '';
      teamSettings.customRewards.forEach(reward => {
        const item = document.createElement('div');
        item.className = 'custom-reward-item';
        item.innerHTML = `
          <div class="custom-reward-info">
            <div class="custom-reward-name">${reward.name}</div>
            <div class="custom-reward-meta">${reward.cost} points ${reward.description ? '¬∑ ' + reward.description : ''}</div>
          </div>
          <button class="btn btn-danger btn-sm" onclick="removeCustomReward('${reward.id}')">Remove</button>
        `;
        container.appendChild(item);
      });
    }

    window.markAttendance = markAttendance;
    window.saveAttendance = saveAttendance;
    window.toggleRewards = toggleRewards;
    window.addCustomReward = addCustomReward;
    window.removeCustomReward = removeCustomReward;

    function populatePlayerDropdown() {
      const players = DataManager.getPlayers();
      const select = document.getElementById('playerAnalyticsSelect');
      
      select.innerHTML = '<option value="">-- Select a player --</option>';
      
      const sortedPlayers = players.sort((a, b) => {
        const nameA = `${a.firstName} ${a.lastName}`.toLowerCase();
        const nameB = `${b.firstName} ${b.lastName}`.toLowerCase();
        return nameA.localeCompare(nameB);
      });
      
      sortedPlayers.forEach(player => {
        const option = document.createElement('option');
        option.value = player.id;
        option.textContent = `${player.firstName} ${player.lastName} - ${player.position} (#${player.jerseyNumber || '?'})`;
        select.appendChild(option);
      });
    }

    function loadPlayerAnalytics(playerId) {
      const playerAnalyticsContainer = document.getElementById('playerAnalyticsContainer');
      const teamAnalyticsContainer = document.getElementById('teamAnalyticsContainer');
      
      if (!playerId) {
        playerAnalyticsContainer.style.display = 'none';
        teamAnalyticsContainer.style.display = 'block';
        return;
      }

      const player = DataManager.getPlayerById(playerId);
      if (!player) return;

      teamAnalyticsContainer.style.display = 'none';
      playerAnalyticsContainer.style.display = 'block';

      playerAnalyticsCharts.forEach(chart => Analytics.destroyChart(chart));
      playerAnalyticsCharts = [];

      const analyticsData = Analytics.generateAnalyticsData(player);

      if (!analyticsData.hasData) {
        playerAnalyticsContainer.innerHTML = `
          <div class="analytics-empty">
            <div class="analytics-empty-icon">üìä</div>
            <h3 class="analytics-empty-title">No Analytics for ${player.firstName} ${player.lastName}</h3>
            <p class="analytics-empty-text">${analyticsData.message}</p>
          </div>
        `;
        return;
      }

      playerAnalyticsContainer.innerHTML = `
        <div class="analytics-container">
          <div class="analytics-header" style="margin-bottom: var(--space-xl);">
            <h2 class="analytics-title">üìà ${player.firstName} ${player.lastName} - Detailed Analytics</h2>
            <p style="color: var(--gray-600);">${player.position} ¬∑ Jersey #${player.jerseyNumber || '?'}</p>
          </div>

          <div class="analytics-stats">
            <div class="stat-card">
              <div class="stat-value">${analyticsData.stats.avgRating}</div>
              <div class="stat-label">Overall Average</div>
            </div>
            <div class="stat-card success">
              <div class="stat-value">${analyticsData.stats.improvementCount}</div>
              <div class="stat-label">Skills Improving</div>
            </div>
            <div class="stat-card warning">
              <div class="stat-value">${analyticsData.stats.totalRatings}</div>
              <div class="stat-label">Total Ratings</div>
            </div>
            <div class="stat-card info">
              <div class="stat-value">${analyticsData.stats.improvementRate}%</div>
              <div class="stat-label">Improvement Rate</div>
            </div>
          </div>

          <div class="chart-grid">
            <div class="chart-card chart-full-width">
              <div class="chart-card-header">
                <h3 class="chart-title">Performance Trends Over Time</h3>
                <span class="chart-icon">üìà</span>
              </div>
              <div class="chart-body">
                <canvas id="playerTimelineChart" class="chart-canvas"></canvas>
              </div>
            </div>

            <div class="chart-card">
              <div class="chart-card-header">
                <h3 class="chart-title">Category Breakdown</h3>
                <span class="chart-icon">üéØ</span>
              </div>
              <div class="chart-body">
                <canvas id="playerRadarChart" class="chart-canvas"></canvas>
              </div>
            </div>

            <div class="chart-card">
              <div class="chart-card-header">
                <h3 class="chart-title">Rating Distribution</h3>
                <span class="chart-icon">üìä</span>
              </div>
              <div class="chart-body">
                <canvas id="playerDistributionChart" class="chart-canvas"></canvas>
              </div>
            </div>
          </div>

          <div class="metric-section">
            <h3 style="margin-bottom: var(--space-lg);">üìå Biggest Changes</h3>
            <div class="progress-list" id="playerProgressList"></div>
          </div>
        </div>
      `;

      setTimeout(() => {
        playerAnalyticsCharts.push(Analytics.createTimelineChart('playerTimelineChart', player));
        playerAnalyticsCharts.push(Analytics.createRadarChart('playerRadarChart', analyticsData.categoryAverages));
        playerAnalyticsCharts.push(Analytics.createDistributionChart('playerDistributionChart', analyticsData.ratingDistribution));

        const progressList = document.getElementById('playerProgressList');
        analyticsData.trends.slice(0, 10).forEach(trend => {
          const trendClass = trend.trend;
          const trendIcon = trend.change > 0 ? '‚Üë' : trend.change < 0 ? '‚Üì' : '‚Üí';
          const trendColor = trend.change > 0 ? 'up' : trend.change < 0 ? 'down' : 'stable';
          
          progressList.innerHTML += `
            <div class="progress-item ${trendClass}">
              <div class="progress-header">
                <span class="progress-name">${trend.label}</span>
                <span class="progress-trend ${trendColor}">
                  ${trendIcon} ${Math.abs(trend.change).toFixed(1)}
                </span>
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${(trend.lastRating / 10) * 100}%;"></div>
              </div>
              <div class="progress-details">
                <span>From ${trend.firstRating}/10</span>
                <span>Now ${trend.lastRating}/10</span>
              </div>
            </div>
          `;
        });
      }, 100);
    }

    window.loadPlayerAnalytics = loadPlayerAnalytics;

    function computeStats(players) {
      document.getElementById('totalPlayers').textContent = players.length;

      let totalVideos = 0;
      let totalPerformance = 0;
      let metricCount = 0;
      let improvingPlayers = 0;
      let totalPoints = 0;

      players.forEach(p => {
        totalVideos += Array.isArray(p.assignedVideos) ? p.assignedVideos.length : 0;
        totalPoints += (p.rewards?.totalPoints || 0);
        
        let playerImproving = false;
        if (p.metrics) {
          Object.values(p.metrics).forEach(category => {
            Object.values(category || {}).forEach(metric => {
              if (metric && typeof metric.level === 'number') {
                totalPerformance += metric.level;
                metricCount++;
              }

              if (metric && Array.isArray(metric.ratingHistory) && metric.ratingHistory.length >= 2) {
                const first = metric.ratingHistory[0].level;
                const last = metric.ratingHistory[metric.ratingHistory.length - 1].level;
                if (last > first) playerImproving = true;
              }
            });
          });
        }
        if (playerImproving) improvingPlayers++;
      });

      document.getElementById('totalVideos').textContent = totalVideos;
      document.getElementById('avgPerformance').textContent = metricCount > 0 ? (totalPerformance / metricCount).toFixed(1) : '0';
      document.getElementById('improvingPlayers').textContent = improvingPlayers;
      document.getElementById('totalPoints').textContent = totalPoints;
    }

    function loadTeamAnalytics() {
      const players = DataManager.getPlayers();
      const container = document.getElementById('teamAnalyticsContainer');

      teamAnalyticsCharts.forEach(chart => Analytics.destroyChart(chart));
      teamAnalyticsCharts = [];

      const coachAnalytics = Analytics.generateCoachAnalytics(players);

      if (!coachAnalytics.hasData) {
        container.innerHTML = `
          <div class="analytics-empty">
            <div class="analytics-empty-icon">üìä</div>
            <h3 class="analytics-empty-title">No Team Data Available</h3>
            <p class="analytics-empty-text">${coachAnalytics.message}</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="analytics-container">
          <div class="analytics-stats">
            <div class="stat-card">
              <div class="stat-value">${coachAnalytics.avgTeamRating}</div>
              <div class="stat-label">Team Avg Rating</div>
            </div>
            <div class="stat-card success">
              <div class="stat-value">${coachAnalytics.playersWithData}</div>
              <div class="stat-label">Players with Ratings</div>
            </div>
            <div class="stat-card info">
              <div class="stat-value">${coachAnalytics.totalRatings}</div>
              <div class="stat-label">Total Metrics Tracked</div>
            </div>
          </div>

          <div class="chart-card chart-full-width">
            <div class="chart-card-header">
              <h3 class="chart-title">Team Performance by Category</h3>
              <span class="chart-icon">üìä</span>
            </div>
            <div class="chart-body">
              <canvas id="teamOverviewChart" class="chart-canvas"></canvas>
            </div>
          </div>

          <div class="grid grid-3" style="margin-bottom: var(--space-xl);">
            <div class="metric-section">
              <h3 style="margin-bottom: var(--space-lg); display: flex; align-items: center; gap: var(--space-sm);">üèÜ Top Performers</h3>
              <div class="player-rank-list">
                ${coachAnalytics.topPerformers.length > 0 ? coachAnalytics.topPerformers.map((p, idx) => `
                  <div class="player-rank-item top">
                    <div>
                      <div style="font-weight: 700; color: var(--gray-900);">#${idx + 1} ${p.name}</div>
                      <div style="font-size: var(--font-size-sm); color: var(--gray-600); margin-top: 2px;">${p.position}</div>
                    </div>
                    <div>
                      <span style="background: #2ecc71; color: white; padding: 6px 14px; border-radius: var(--radius-full); font-weight: 700; font-size: var(--font-size-sm);">${p.avgRating}/10</span>
                    </div>
                  </div>
                `).join('') : '<p style="color: var(--gray-500); text-align: center; padding: var(--space-lg); font-style: italic;">No data available</p>'}
              </div>
            </div>

            <div class="metric-section">
              <h3 style="margin-bottom: var(--space-lg); display: flex; align-items: center; gap: var(--space-sm);">üìà Most Improved</h3>
              <div class="player-rank-list">
                ${coachAnalytics.mostImproved.length > 0 ? coachAnalytics.mostImproved.map((p, idx) => `
                  <div class="player-rank-item improved">
                    <div>
                      <div style="font-weight: 700; color: var(--gray-900);">#${idx + 1} ${p.name}</div>
                      <div style="font-size: var(--font-size-sm); color: var(--gray-600); margin-top: 2px;">${p.position}</div>
                    </div>
                    <div>
                      <span style="background: #3498db; color: white; padding: 6px 14px; border-radius: var(--radius-full); font-weight: 700; font-size: var(--font-size-sm);">+${p.improvementRate}%</span>
                    </div>
                  </div>
                `).join('') : '<p style="color: var(--gray-500); text-align: center; padding: var(--space-lg); font-style: italic;">No improvement data yet</p>'}
              </div>
            </div>

            <div class="metric-section">
              <h3 style="margin-bottom: var(--space-lg); display: flex; align-items: center; gap: var(--space-sm);">‚ö†Ô∏è Needs Attention</h3>
              <div class="player-rank-list">
                ${coachAnalytics.needsAttention.length > 0 ? coachAnalytics.needsAttention.map((p) => `
                  <div class="player-rank-item attention">
                    <div>
                      <div style="font-weight: 700; color: var(--gray-900);">${p.name}</div>
                      <div style="font-size: var(--font-size-sm); color: var(--gray-600); margin-top: 2px;">${p.position} ¬∑ ${p.avgRating}/10</div>
                    </div>
                    <div>
                      <span style="background: #e74c3c; color: white; padding: 6px 14px; border-radius: var(--radius-full); font-weight: 700; font-size: var(--font-size-sm);">Focus</span>
                    </div>
                  </div>
                `).join('') : '<p style="color: var(--gray-500); text-align: center; padding: var(--space-lg); font-style: italic;">All players performing well!</p>'}
              </div>
            </div>
          </div>

          <div class="metric-section">
            <h3 style="margin-bottom: var(--space-lg);">üéØ Team Focus Areas</h3>
            <div class="grid grid-2">
              ${Object.entries(coachAnalytics.categoryAverages).map(([cat, avg]) => {
                const labels = {
                  technical: '‚ö° Technical Skills',
                  mentality: 'üß† Mentality',
                  intelligence: 'üéØ Intelligence',
                  athleticism: 'üí™ Athleticism'
                };
                const color = avg >= 7 ? '#2ecc71' : avg >= 5 ? '#f39c12' : '#e74c3c';
                return `
                  <div style="background: white; padding: var(--space-lg); border-radius: var(--radius-md); border-left: 4px solid ${color}; box-shadow: var(--shadow-sm);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="font-weight: 600; font-size: var(--font-size-lg);">${labels[cat] || cat}</span>
                      <span style="background: ${color}; color: white; padding: 8px 16px; border-radius: var(--radius-full); font-weight: 700;">${avg}/10</span>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;

      setTimeout(() => {
        teamAnalyticsCharts.push(Analytics.createTeamOverviewChart('teamOverviewChart', coachAnalytics));
      }, 100);
    }

    function renderPlayers() {
      const players = DataManager.getPlayers();
      const playersList = document.getElementById('playersList');

      // Initialize rewards for all players
      players.forEach(player => {
        if (!player.rewards) {
          Rewards.initializePlayerRewards(player);
        }
      });

      computeStats(players);

      playersList.innerHTML = '';
      if (!players.length) {
        playersList.innerHTML = '<p style="text-align:center;color:var(--gray-500);padding:var(--space-xl);">No players added yet. Add your first player to get started!</p>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'grid grid-2';

      players.forEach(player => {
        let totalMetrics = 0;
        let metricsSum = 0;

        if (player.metrics) {
          Object.values(player.metrics).forEach(category => {
            Object.values(category || {}).forEach(metric => {
              if (metric && typeof metric.level === 'number') {
                metricsSum += metric.level;
                totalMetrics++;
              }
            });
          });
        }

        const avgLevel = totalMetrics > 0 ? (metricsSum / totalMetrics).toFixed(1) : '0';
        const summary = Rewards.getRewardsSummary(player);

        const card = document.createElement('div');
        card.className = 'card';

        card.innerHTML = `
          <div class="card-header">
            <div style="display:flex;justify-content:space-between;align-items:start;">
              <div>
                <h3 class="card-title" style="margin:0;">${player.firstName || ''} ${player.lastName || ''}</h3>
                <p style="color:var(--gray-500);font-size:var(--font-size-sm);margin:0;">
                  ${player.position || ''} ${player.jerseyNumber ? '¬∑ #' + player.jerseyNumber : ''}
                </p>
              </div>
              <span class="badge badge-success">${player.code || ''}</span>
            </div>
          </div>
          <div class="card-body">
            <div style="display:flex;justify-content:space-between;margin-bottom:var(--space-md);">
              <div>
                <p style="font-size:var(--font-size-sm);color:var(--gray-600);margin:0;">Avg Performance</p>
                <p style="font-size:20px;font-weight:700;color:var(--primary);margin:0;">${avgLevel}/10</p>
              </div>
              <div>
                <p style="font-size:var(--font-size-sm);color:var(--gray-600);margin:0;">Videos</p>
                <p style="font-size:20px;font-weight:700;color:var(--secondary);margin:0;">${Array.isArray(player.assignedVideos) ? player.assignedVideos.length : 0}</p>
              </div>
              <div>
                <p style="font-size:var(--font-size-sm);color:var(--gray-600);margin:0;">Points</p>
                <p style="font-size:20px;font-weight:700;color:#ffa500;margin:0;">${summary.totalPoints}</p>
              </div>
            </div>
          </div>
          <div class="card-footer" style="padding:var(--space-md) 0;gap:var(--space-sm);">
            <button class="btn btn-primary btn-sm" data-action="edit" data-id="${player.id}">Edit</button>
            <button class="btn btn-outline btn-sm" data-action="view" data-id="${player.id}">View Profile</button>
            <button class="btn btn-danger btn-sm" data-action="delete" data-id="${player.id}">Delete</button>
          </div>
        `;

        grid.appendChild(card);
      });

      playersList.appendChild(grid);
    }

    function getDefaultMetrics() {
      const metrics = {};
      Object.entries(METRIC_CONFIG).forEach(([catKey, catCfg]) => {
        metrics[catKey] = {};
        Object.keys(catCfg.metrics).forEach(metricKey => {
          metrics[catKey][metricKey] = { level: 0, comment: '', ratingHistory: [] };
        });
      });
      return metrics;
    }

    function viewPlayer(playerId) {
      const player = DataManager.getPlayerById(playerId);
      if (!player) return;

      document.getElementById('modalPlayerName').textContent = `${player.firstName || ''} ${player.lastName || ''}`;

      let html = `
        <div style="margin-bottom: var(--space-lg);">
          <p><strong>Position:</strong> ${player.position || '-'}</p>
          <p><strong>Jersey #:</strong> ${player.jerseyNumber || '-'}</p>
          <p><strong>Date of Birth:</strong> ${UI.formatDate(player.dateOfBirth)}</p>
          <p><strong>Player Code:</strong> <span style="background-color: var(--primary-light); padding: var(--space-sm) var(--space-md); border-radius: var(--radius-md); font-weight: 600; color: var(--primary);">${player.code || ''}</span></p>
        </div>

        <h4 style="border-bottom:2px solid var(--gray-200);padding-bottom:var(--space-md);margin-bottom:var(--space-md);">Performance Metrics</h4>
      `;

      Object.entries(METRIC_CONFIG).forEach(([catKey, catCfg]) => {
        html += `<div style="background-color: var(--gray-50); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md);">
          <h5 style="margin-bottom: var(--space-md);">${catCfg.label}</h5>`;

        const category = (player.metrics && player.metrics[catKey]) ? player.metrics[catKey] : {};

        Object.entries(catCfg.metrics).forEach(([metricKey, label]) => {
          const metric = category[metricKey] || { level: 0, comment: '' };
          const color = UI.getMetricRatingColor(metric.level || 0);
          html += `
            <div style="margin-bottom: var(--space-md);">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-sm);">
                <span style="font-weight:500;">${label}</span>
                <span style="background-color:${color};color:white;padding:2px 8px;border-radius:var(--radius-sm);font-weight:600;font-size:var(--font-size-sm);">${metric.level || 0}/10</span>
              </div>
              <p style="margin:0;font-size:var(--font-size-sm);color:var(--gray-600);">${metric.comment || ''}</p>
            </div>
          `;
        });

        html += `</div>`;
      });

      html += `<h4 style="border-bottom:2px solid var(--gray-200);padding-bottom:var(--space-md);margin:var(--space-lg) 0 var(--space-md);">Assigned Videos</h4>`;

      if (Array.isArray(player.assignedVideos) && player.assignedVideos.length) {
        player.assignedVideos.forEach(v => {
          html += `
            <div style="background-color: var(--gray-50); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-md); display:flex; justify-content:space-between; align-items:center;">
              <div>
                <p style="font-weight:600;margin:0;">${v.title || ''}</p>
                <p style="font-size:var(--font-size-sm);color:var(--gray-500);margin:0;">Assigned: ${UI.formatDate(v.assignedDate)}</p>
              </div>
              <button class="btn btn-danger btn-sm" onclick="removeVideo('${player.id}', '${v.id}')">Remove</button>
            </div>
          `;
        });
      } else {
        html += '<p style="color: var(--gray-500); font-style: italic;">No videos assigned yet.</p>';
      }

      const aiSummary = AI.generatePlayerSummary(player);
      html += `
        <div style="margin-top: var(--space-xl); padding: var(--space-lg); border-radius: var(--radius-lg); background: var(--gray-50); border-left: 4px solid var(--primary);">
          <h4 style="margin-bottom: var(--space-md);">AI Development Summary (beta)</h4>
          <p style="margin-bottom: var(--space-sm);">${aiSummary.overallText}</p>
          <p style="margin-bottom: var(--space-xs);"><strong>Strengths:</strong> ${aiSummary.strengthsText}</p>
          <p><strong>Focus areas:</strong> ${aiSummary.focusText}</p>
        </div>
      `;

      html += `
        <div style="margin-top: var(--space-lg); display:flex; gap: var(--space-md);">
          <button class="btn btn-secondary" onclick="openVideoModal('${player.id}')">Assign Video</button>
        </div>
      `;

      document.getElementById('playerDetails').innerHTML = html;
      UI.openModal('playerModal');
    }

    function editPlayer(playerId) {
      const player = DataManager.getPlayerById(playerId);
      if (!player) return;

      document.getElementById('modalPlayerName').textContent = `Edit: ${player.firstName || ''} ${player.lastName || ''}`;

      let html = `
        <form id="editPlayerForm">
          <div style="margin-bottom: var(--space-lg); display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: var(--space-md);">
            <div class="form-group">
              <label class="form-label">First Name</label>
              <input type="text" class="form-input" name="firstName" value="${player.firstName || ''}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Last Name</label>
              <input type="text" class="form-input" name="lastName" value="${player.lastName || ''}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Position</label>
              <input type="text" class="form-input" name="position" value="${player.position || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Jersey Number</label>
              <input type="number" class="form-input" name="jerseyNumber" value="${player.jerseyNumber || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-input" name="dateOfBirth" value="${player.dateOfBirth || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Player Code (read-only)</label>
              <input type="text" class="form-input" value="${player.code || ''}" disabled>
            </div>
          </div>

          <div class="rating-context-section">
            <h4 style="margin-bottom: var(--space-md);">üìã Rating Context</h4>
            <p style="font-size: var(--font-size-sm); color: var(--gray-600); margin-bottom: var(--space-md);">Select the type of assessment you're recording:</p>
            
            <div class="context-grid">
              <div class="form-group">
                <label class="form-label">Rating Type</label>
                <select class="form-select" name="ratingContextType" id="ratingContextType" onchange="handleContextTypeChange()">
                  <option value="manual">General Update</option>
                  <option value="training">Training Session</option>
                  <option value="game">Game/Match</option>
                  <option value="weekly">Weekly Review</option>
                  <option value="biweekly">Bi-weekly Review</option>
                  <option value="monthly">Monthly Review</option>
                </select>
              </div>
              
              <div class="form-group" id="contextDateGroup" style="display: none;">
                <label class="form-label">Session/Game Date</label>
                <input type="date" class="form-input" name="contextDate" id="contextDate">
              </div>
              
              <div class="form-group" id="trainingTypeGroup" style="display: none;">
                <label class="form-label">Training Focus</label>
                <select class="form-select" name="trainingType" id="trainingType">
                  <option value="technical">Technical</option>
                  <option value="tactical">Tactical</option>
                  <option value="fitness">Fitness</option>
                  <option value="mental">Mental/Team</option>
                  <option value="recovery">Recovery</option>
                </select>
              </div>
            </div>
          </div>

          <h4 style="border-bottom: 2px solid var(--gray-200); padding-bottom: var(--space-md); margin-bottom: var(--space-md);">
            Performance Metrics (0‚Äì10) & Comments
          </h4>
      `;

      Object.entries(METRIC_CONFIG).forEach(([catKey, catCfg]) => {
        const playerCat = (player.metrics && player.metrics[catKey]) ? player.metrics[catKey] : {};
        html += `<div style="background-color: var(--gray-50); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
          <h5 style="margin-bottom: var(--space-md);">${catCfg.label}</h5>`;

        Object.entries(catCfg.metrics).forEach(([metricKey, metricLabel]) => {
          const current = playerCat[metricKey] || {};
          const lvl = (typeof current.level === 'number') ? current.level : 0;
          const cmt = current.comment || '';
          html += `
            <div class="form-group" style="margin-bottom: var(--space-md);">
              <label class="form-label">${metricLabel}</label>
              <div style="display:flex;align-items:center;gap:var(--space-md);margin-bottom:var(--space-xs);">
                <input type="number" class="form-input" name="level-${catKey}-${metricKey}" min="0" max="10" value="${lvl}" style="max-width: 90px;" required>
                <span style="font-size: var(--font-size-sm); color: var(--gray-600);">0 = not rated, 1 = needs lots of work, 10 = elite</span>
              </div>
              <textarea class="form-input" name="comment-${catKey}-${metricKey}" rows="2" placeholder="Coach comment for this area...">${cmt}</textarea>
            </div>
          `;
        });

        html += `</div>`;
      });

      html += `
          <div style="margin-top: var(--space-lg); display:flex; gap: var(--space-md); justify-content:flex-end;">
            <button type="button" class="btn btn-outline" onclick="UI.closeModal('playerModal')">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      `;

      document.getElementById('playerDetails').innerHTML = html;
      UI.openModal('playerModal');

      document.getElementById('contextDate').value = new Date().toISOString().split('T')[0];

      document.getElementById('editPlayerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const form = e.target;
        const updatedMetrics = {};

        Object.entries(METRIC_CONFIG).forEach(([catKey, catCfg]) => {
          updatedMetrics[catKey] = {};
          Object.keys(catCfg.metrics).forEach(metricKey => {
            const levelInput = form.querySelector(`[name="level-${catKey}-${metricKey}"]`);
            const commentInput = form.querySelector(`[name="comment-${catKey}-${metricKey}"]`);
            let level = parseInt(levelInput.value, 10);
            if (Number.isNaN(level)) level = 0;
            if (level < 0) level = 0;
            if (level > 10) level = 10;

            updatedMetrics[catKey][metricKey] = {
              level,
              comment: (commentInput.value || '').trim()
            };
          });
        });

        const ratingContext = {
          type: form.ratingContextType.value,
          contextDate: form.contextDate ? form.contextDate.value : null,
          trainingType: form.trainingType ? form.trainingType.value : null
        };

        const updatedData = {
          firstName: (form.firstName.value || '').trim(),
          lastName: (form.lastName.value || '').trim(),
          position: (form.position.value || '').trim(),
          jerseyNumber: form.jerseyNumber.value ? parseInt(form.jerseyNumber.value, 10) : null,
          dateOfBirth: form.dateOfBirth.value || null,
          metrics: updatedMetrics,
          ratingContext
        };

        try {
          await DataManager.updatePlayer(playerId, updatedData);
          
          // Check for performance improvement and award points
          const updatedPlayer = DataManager.getPlayerById(playerId);
          await Rewards.checkPerformanceImprovement(updatedPlayer);
          
          UI.showAlert('Player updated successfully! Analytics will reflect new data.', 'success');
          await DataManager.init(true);
          renderPlayers();
          UI.closeModal('playerModal');
        } catch (err) {
          UI.showAlert(err.message || 'Failed to update player', 'danger');
        }
      }, { once: true });
    }

    function handleContextTypeChange() {
      const contextType = document.getElementById('ratingContextType').value;
      const contextDateGroup = document.getElementById('contextDateGroup');
      const trainingTypeGroup = document.getElementById('trainingTypeGroup');

      if (contextType === 'training' || contextType === 'game') {
        contextDateGroup.style.display = 'block';
      } else {
        contextDateGroup.style.display = 'none';
      }

      if (contextType === 'training') {
        trainingTypeGroup.style.display = 'block';
      } else {
        trainingTypeGroup.style.display = 'none';
      }
    }

    async function deletePlayer(playerId) {
      if (!confirm('Are you sure you want to delete this player? This action cannot be undone.')) return;
      try {
        await DataManager.deletePlayer(playerId);
        UI.showAlert('Player deleted successfully', 'success');
        await DataManager.init(true);
        renderPlayers();
      } catch (err) {
        UI.showAlert(err.message || 'Failed to delete player', 'danger');
      }
    }

    async function openVideoModal(playerId) {
      const title = prompt('Video Title:');
      if (!title) return;
      const url = prompt('Video URL (YouTube, Vimeo, or embed URL):');
      if (!url) return;

      try {
        await DataManager.addVideo(playerId, { title, url });
        UI.showAlert('Video assigned successfully', 'success');
        await DataManager.init(true);
        renderPlayers();
        viewPlayer(playerId);
      } catch (err) {
        UI.showAlert(err.message || 'Failed to assign video', 'danger');
      }
    }

    async function removeVideo(playerId, videoId) {
      if (!confirm('Are you sure you want to remove this video?')) return;
      try {
        await DataManager.removeVideo(playerId, videoId);
        UI.showAlert('Video removed', 'success');
        await DataManager.init(true);
        renderPlayers();
        viewPlayer(playerId);
      } catch (err) {
        UI.showAlert(err.message || 'Failed to remove video', 'danger');
      }
    }

    window.openVideoModal = openVideoModal;
    window.removeVideo = removeVideo;
    window.handleContextTypeChange = handleContextTypeChange;

    document.addEventListener('DOMContentLoaded', async () => {
      const ok = await Auth.checkAdminAuth();
      if (!ok) return;

      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.getAttribute('data-tab')));
      });

      document.getElementById('logoutLink').addEventListener('click', async (e) => {
        e.preventDefault();
        await Auth.logoutAdmin();
        window.location.href = 'index.html';
      });

      // Initalize data
      await DataManager.init(true);
      renderPlayers();

      // load history only after data is initalized
      loadAttendanceHistory();

      document.getElementById('playersList').addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const action = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id');
        if (action === 'view') viewPlayer(id);
        if (action === 'edit') editPlayer(id);
        if (action === 'delete') deletePlayer(id);
      });

      document.getElementById('addPlayerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        try {
          const player = await DataManager.addPlayer({
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            position: document.getElementById('position').value.trim(),
            jerseyNumber: document.getElementById('jerseyNumber').value ? parseInt(document.getElementById('jerseyNumber').value, 10) : null,
            dateOfBirth: document.getElementById('dateOfBirth').value || null,
            metrics: getDefaultMetrics(),
            assignedVideos: []
          });

          UI.showAlert(`Player added. Code: ${player.code}`, 'success');
          e.target.reset();
          await DataManager.init(true);
          renderPlayers();
          switchTab('players-tab');
        } catch (err) {
          UI.showAlert(err.message || 'Failed to add player', 'danger');
        }
      });
    });
  </script>
  </body>
</html>
