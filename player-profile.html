<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Profile - TrackerU</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/analytics.css">
    <link rel="stylesheet" href="css/rewards.css">
    <style>
        .profile-header {
            background: linear-gradient(135deg, var(--primary), #0f172a);
            color: white;
            padding: var(--space-2xl) 0;
            margin-bottom: var(--space-xl);
        }
        
        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        .info-card {
            background: white;
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }
        
        .info-label {
            color: var(--gray-500);
            font-size: var(--font-size-sm);
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .info-value {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--gray-900);
            margin-top: var(--space-sm);
        }
        
        .metric-section {
            background: white;
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-lg);
        }
        
        .metric-item {
            padding: var(--space-md);
            background-color: var(--gray-50);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
        }
        
        .metric-name {
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .metric-level {
            font-weight: 700;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            color: white;
            font-size: var(--font-size-sm);
        }
        
        .metric-comment {
            color: var(--gray-600);
            font-size: var(--font-size-sm);
            margin-top: var(--space-sm);
            font-style: italic;
        }
        
        .video-card {
            background-color: var(--gray-50);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-md);
            border-left: 4px solid var(--secondary);
        }
        
        .video-title {
            font-weight: 600;
            margin-bottom: var(--space-sm);
        }
        
        .video-date {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
        }
        
        .tabs {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            border-bottom: 2px solid var(--gray-200);
            flex-wrap: wrap;
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: var(--space-md);
            border-bottom: 3px solid transparent;
            font-weight: 600;
            cursor: pointer;
            color: var(--gray-600);
            transition: var(--transition);
        }
        
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }

        .ai-summary {
            background: linear-gradient(135deg, var(--primary-light), #f0f9ff);
            border-left: 4px solid var(--primary);
            padding: var(--space-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-xl);
            box-shadow: var(--shadow-md);
        }

        .ai-summary h4 {
            color: var(--primary);
            margin-bottom: var(--space-md);
        }

        .ai-summary p {
            color: var(--gray-700);
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <div class="navbar-brand-icon">‚öΩ</div>
                <span>TrackerU</span>
            </div>
            <ul class="navbar-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="player-access.html">Back to Access</a></li>
                <li><a href="#" onclick="logoutPlayer()" style="cursor: pointer;">Logout</a></li>
            </ul>
        </div>
    </nav>

    <!-- Profile Header -->
    <div class="profile-header">
        <div class="container">
            <h1 id="playerName">Loading...</h1>
            <p id="playerDetails" style="color: rgba(255,255,255,0.9); margin: 0;"></p>
        </div>
    </div>

    <div class="container">
        <!-- Player Info -->
        <div class="profile-info" id="profileInfo">
            <div class="info-card">
                <div class="info-label">Position</div>
                <div class="info-value" id="position">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">Jersey Number</div>
                <div class="info-value" id="jerseyNumber">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">Date of Birth</div>
                <div class="info-value" id="dob">-</div>
            </div>
            <div class="info-card">
                <div class="info-label">Overall Performance</div>
                <div class="info-value" id="overallPerformance">-</div>
            </div>
        </div>

        <!-- AI Summary Section -->
        <div id="aiSummarySection"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('metrics-tab')">üìä Performance Metrics</button>
            <button class="tab-btn" onclick="switchTab('analytics-tab')">üìà Analytics</button>
            <button class="tab-btn" onclick="switchTab('rewards-tab')">üèÜ Rewards & Badges</button>
            <button class="tab-btn" onclick="switchTab('videos-tab')">üé¨ Training Videos</button>
        </div>

        <!-- Metrics Tab -->
        <div id="metrics-tab" class="tab-pane active">
            <div id="metricsContainer"></div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-pane">
            <div id="analyticsContainer"></div>
        </div>

        <!-- Rewards Tab -->
        <div id="rewards-tab" class="tab-pane">
            <div id="rewardsContainer"></div>
        </div>

        <!-- Videos Tab -->
        <div id="videos-tab" class="tab-pane">
            <div class="metric-section">
                <h3 style="margin-bottom: var(--space-lg);">üé¨ Assigned Training Videos</h3>
                <div id="videosContainer"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <script src="js/app.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/rewards.js"></script>
    <script>
        const playerCode = Auth.getCurrentPlayerCode();
        if (!playerCode) {
            window.location.href = 'player-access.html';
        }

        let currentPlayer = null;
        let analyticsCharts = [];

        async function loadPlayerProfile() {
            const player = await DataManager.getPlayerByCode(playerCode);
            
            if (!player) {
                window.location.href = 'player-access.html';
                return;
            }

            currentPlayer = Rewards.initializePlayerRewards(player);

            document.getElementById('playerName').textContent = `${player.firstName} ${player.lastName}`;
            document.getElementById('playerDetails').textContent = `${player.position} | Jersey #${player.jerseyNumber}`;

            document.getElementById('position').textContent = player.position;
            document.getElementById('jerseyNumber').textContent = player.jerseyNumber;
            document.getElementById('dob').textContent = UI.formatDate(player.dateOfBirth);

            let totalLevel = 0;
            let totalMetrics = 0;
            
            Object.values(player.metrics).forEach(category => {
                Object.values(category).forEach(metric => {
                    totalLevel += metric.level;
                    totalMetrics++;
                });
            });
            
            const avgLevel = totalMetrics > 0 ? (totalLevel / totalMetrics).toFixed(1) : 0;
            document.getElementById('overallPerformance').textContent = `${avgLevel}/10`;

            // Add points card to profile info
            const pointsCard = document.createElement('div');
            pointsCard.className = 'info-card';
            pointsCard.style.background = 'linear-gradient(135deg, #ffd700, #ffa500)';
            pointsCard.style.color = 'white';
            pointsCard.innerHTML = `
                <div class="info-label" style="color: rgba(255,255,255,0.9);">Total Points</div>
                <div class="info-value" style="color: white;">${currentPlayer.rewards.totalPoints} üåü</div>
            `;
            document.getElementById('profileInfo').appendChild(pointsCard);

            loadAISummary(player);
            loadMetrics(player);
            loadVideos(player);
        }

        function loadAISummary(player) {
            const aiSummary = AI.generatePlayerSummary(player);
            const summarySection = document.getElementById('aiSummarySection');
            
            summarySection.innerHTML = `
                <div class="ai-summary">
                    <h4>ü§ñ AI Development Summary</h4>
                    <p style="margin-bottom: var(--space-sm);">${aiSummary.overallText}</p>
                    <p style="margin-bottom: var(--space-xs);"><strong>Strengths:</strong> ${aiSummary.strengthsText}</p>
                    <p style="margin: 0;"><strong>Focus areas:</strong> ${aiSummary.focusText}</p>
                </div>
            `;
        }

        function loadMetrics(player) {
            const metricsContainer = document.getElementById('metricsContainer');
            metricsContainer.innerHTML = '';

            const categories = {
                technical: { title: '‚ö° Technical Skills', icon: '‚ö°' },
                mentality: { title: 'üß† Mentality', icon: 'üß†' },
                intelligence: { title: 'üéØ Soccer Intelligence', icon: 'üéØ' },
                athleticism: { title: 'üí™ Athleticism', icon: 'üí™' }
            };

            const metricLabels = {
                ballControl: 'Ball Control (Receiving)',
                ballStriking: 'Ball Striking',
                passing: 'Passing',
                duels: '1v1 Duel Ability',
                emotionControl: 'Emotion Control',
                selfDevelopment: 'Self Development',
                vocal: 'Vocal Leadership',
                performance: 'Performance Consistency',
                focus: 'Focus & Concentration',
                anticipation: 'Game Anticipation',
                decisionMaking: 'Decision Making',
                versatility: 'Versatility',
                spaceUsage: 'Space Usage',
                agility: 'Agility',
                speed: 'Speed',
                stamina: 'Stamina'
            };

            Object.entries(player.metrics).forEach(([catKey, category]) => {
                const section = document.createElement('div');
                section.className = 'metric-section';
                
                let html = `<h3 style="margin-bottom: var(--space-lg);">${categories[catKey].title}</h3>`;

                Object.entries(category).forEach(([metricKey, metric]) => {
                    const color = UI.getMetricRatingColor(metric.level);
                    const displayName = metricLabels[metricKey] || metricKey;
                    
                    html += `
                        <div class="metric-item">
                            <div class="metric-header">
                                <span class="metric-name">${displayName}</span>
                                <span class="metric-level" style="background-color: ${color};">${metric.level}/10</span>
                            </div>
                            ${metric.comment ? `<div class="metric-comment">üí¨ ${metric.comment}</div>` : ''}
                        </div>
                    `;
                });

                section.innerHTML = html;
                metricsContainer.appendChild(section);
            });
        }

        function loadVideos(player) {
            const videosContainer = document.getElementById('videosContainer');
            videosContainer.innerHTML = '';

            if (!player.assignedVideos || player.assignedVideos.length === 0) {
                videosContainer.innerHTML = '<p style="color: var(--gray-500); text-align: center; padding: var(--space-lg);">No training videos assigned yet. Check back soon!</p>';
                return;
            }

            player.assignedVideos.forEach(video => {
                const videoCard = document.createElement('div');
                videoCard.className = 'video-card';
                
                const embedUrl = UI.convertToEmbedUrl(video.url);
                
                videoCard.innerHTML = `
                    <div class="video-title">${video.title}</div>
                    <div class="video-date">üìÖ Assigned: ${UI.formatDate(video.assignedDate)}</div>
                    ${embedUrl ? `
                        <div style="margin-top: var(--space-md);">
                            <iframe width="100%" height="315" src="${embedUrl}" 
                                frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen style="border-radius: var(--radius-md);"></iframe>
                        </div>
                    ` : ''}
                `;
                
                videosContainer.appendChild(videoCard);
            });
        }

        async function loadRewards(player) {
            const rewardsContainer = document.getElementById('rewardsContainer');
            const summary = Rewards.getRewardsSummary(player);
            
            // 1. Fetch Settings from Supabase
            const settings = await DataManager.getTeamSettings();

            let html = `
                <div class="points-banner">
                    <div class="points-value">${summary.totalPoints}</div>
                    <div class="points-label">Total Points Earned</div>
                    <div class="points-stats">
                        <div class="points-stat">
                            <div class="points-stat-value">${summary.badgeCount}</div>
                            <div class="points-stat-label">Badges</div>
                        </div>
                        <div class="points-stat">
                            <div class="points-stat-value">${summary.videosWatched}</div>
                            <div class="points-stat-label">Videos</div>
                        </div>
                        <div class="points-stat">
                            <div class="points-stat-value">${summary.attendanceCount}</div>
                            <div class="points-stat-label">Sessions</div>
                        </div>
                        <div class="points-stat">
                            <div class="points-stat-value">${summary.currentStreak}</div>
                            <div class="points-stat-label">Streak</div>
                        </div>
                    </div>
                </div>`;

            // 2. SHOW REDEMPTION SECTION ONLY IF ENABLED
            if (settings.rewardsEnabled && settings.customRewards.length > 0) {
                html += `
                <div class="metric-section" style="background: #fff8e1; border-left: 4px solid #f39c12;">
                    <h3 style="margin-bottom: var(--space-md);">üéÅ Rewards Marketplace</h3>
                    <p style="font-size: 0.9em; color: var(--gray-600); margin-bottom: var(--space-lg);">Redeem your hard-earned points for real rewards from your coach!</p>
                    <div class="grid grid-2">
                `;
                
                settings.customRewards.forEach(reward => {
                    const canAfford = player.rewards.totalPoints >= reward.cost;
                    html += `
                        <div style="background: white; padding: var(--space-md); border-radius: var(--radius-md); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; justify-content: space-between;">
                            <div>
                                <div style="font-weight: 700; font-size: 1.1em;">${reward.name}</div>
                                <div style="color: var(--gray-600); font-size: 0.9em;">${reward.description}</div>
                            </div>
                            <div style="margin-top: var(--space-md); display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 700; color: #f39c12;">${reward.cost} pts</span>
                                <button class="btn btn-sm ${canAfford ? 'btn-primary' : 'btn-outline'}" 
                                    style="${canAfford ? '' : 'opacity: 0.5; cursor: not-allowed;'}"
                                    onclick="${canAfford ? `redeemReward('${reward.id}', ${reward.cost}, '${reward.name}')` : ''}">
                                    ${canAfford ? 'Redeem' : 'Need Points'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }

            // 3. Badges Section
            html += `
                <div class="metric-section">
                    <h3 style="margin-bottom: var(--space-lg);">üèÜ Your Badges</h3>
                    <div class="badges-container" id="badgesContainer"></div>
                </div>
            `;
            
            rewardsContainer.innerHTML = html;

            // Render badges
            const badgesContainer = document.getElementById('badgesContainer');
            Object.values(Rewards.BADGES).forEach(badge => {
                const earned = player.rewards.earnedBadges.find(b => b.id === badge.id);
                const progress = Rewards.getBadgeProgress(player, badge);
                
                const badgeCard = document.createElement('div');
                badgeCard.className = `badge-card ${earned ? 'earned' : 'locked'}`;
                badgeCard.innerHTML = `
                    <div class="badge-icon">${badge.icon}</div>
                    <div class="badge-name">${badge.name}</div>
                    <div class="badge-description">${badge.description}</div>
                    ${earned ? `<div class="badge-earned-date">‚úì Earned ${UI.formatDate(earned.earnedAt)}</div>` : ''}
                    ${!earned && progress > 0 ? `
                        <div class="badge-progress-bar">
                            <div class="badge-progress-fill" style="width: ${progress}%;"></div>
                        </div>
                    ` : ''}
                `;
                badgesContainer.appendChild(badgeCard);
            });
        }

        // Add this helper function to handle redemptions
        async function redeemReward(rewardId, cost, name) {
            if(!confirm(`Spend ${cost} points to redeem "${name}"?`)) return;
            
            try {
                // Update local object
                const updatedPlayer = Rewards.redeemReward(currentPlayer, cost, name);
                
                // Save to Supabase
                await DataManager.updatePlayer(updatedPlayer.id, { rewards: updatedPlayer.rewards });
                
                alert(`Successfully redeemed ${name}! Show this to your coach.`);
                loadPlayerProfile(); // Refresh UI
            } catch(err) {
                alert("Error: " + err.message);
            }
        }

        function loadAnalytics(player) {
            const analyticsContainer = document.getElementById('analyticsContainer');
            const analyticsData = Analytics.generateAnalyticsData(player);

            analyticsCharts.forEach(chart => Analytics.destroyChart(chart));
            analyticsCharts = [];

            if (!analyticsData.hasData) {
                analyticsContainer.innerHTML = `
                    <div class="analytics-empty">
                        <div class="analytics-empty-icon">üìä</div>
                        <h3 class="analytics-empty-title">No Analytics Available Yet</h3>
                        <p class="analytics-empty-text">${analyticsData.message}</p>
                    </div>
                `;
                return;
            }

            analyticsContainer.innerHTML = `
                <div class="analytics-container">
                    <div class="analytics-header">
                        <h2 class="analytics-title">üìà Performance Analytics</h2>
                    </div>
                    <div class="analytics-stats">
                        <div class="stat-card">
                            <div class="stat-value">${analyticsData.stats.avgRating}</div>
                            <div class="stat-label">Overall Average</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-value">${analyticsData.stats.improvementCount}</div>
                            <div class="stat-label">Skills Improving</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-value">${analyticsData.stats.totalRatings}</div>
                            <div class="stat-label">Total Ratings</div>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-value">${analyticsData.stats.improvementRate}%</div>
                            <div class="stat-label">Improvement Rate</div>
                        </div>
                    </div>
                    <div class="chart-grid">
                        <div class="chart-card chart-full-width">
                            <div class="chart-card-header">
                                <h3 class="chart-title">Performance Trends Over Time</h3>
                                <span class="chart-icon">üìà</span>
                            </div>
                            <div class="chart-body">
                                <canvas id="timelineChart" class="chart-canvas"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card-header">
                                <h3 class="chart-title">Category Breakdown</h3>
                                <span class="chart-icon">üéØ</span>
                            </div>
                            <div class="chart-body">
                                <canvas id="radarChart" class="chart-canvas"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-card-header">
                                <h3 class="chart-title">Rating Distribution</h3>
                                <span class="chart-icon">üìä</span>
                            </div>
                            <div class="chart-body">
                                <canvas id="distributionChart" class="chart-canvas"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="metric-section">
                        <h3 style="margin-bottom: var(--space-lg);">üìå Biggest Changes</h3>
                        <div class="progress-list" id="progressList"></div>
                    </div>
                </div>
            `;

            setTimeout(() => {
                analyticsCharts.push(Analytics.createTimelineChart('timelineChart', player));
                analyticsCharts.push(Analytics.createRadarChart('radarChart', analyticsData.categoryAverages));
                analyticsCharts.push(Analytics.createDistributionChart('distributionChart', analyticsData.ratingDistribution));

                const progressList = document.getElementById('progressList');
                analyticsData.trends.slice(0, 10).forEach(trend => {
                    const trendClass = trend.trend;
                    const trendIcon = trend.change > 0 ? '‚Üë' : trend.change < 0 ? '‚Üì' : '‚Üí';
                    const trendColor = trend.change > 0 ? 'up' : trend.change < 0 ? 'down' : 'stable';
                    
                    progressList.innerHTML += `
                        <div class="progress-item ${trendClass}">
                            <div class="progress-header">
                                <span class="progress-name">${trend.label}</span>
                                <span class="progress-trend ${trendColor}">${trendIcon} ${Math.abs(trend.change).toFixed(1)}</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${(trend.lastRating / 10) * 100}%;"></div>
                            </div>
                            <div class="progress-details">
                                <span>From ${trend.firstRating}/10</span>
                                <span>Now ${trend.lastRating}/10</span>
                            </div>
                        </div>
                    `;
                });
            }, 100);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'analytics-tab' && currentPlayer) {
                loadAnalytics(currentPlayer);
            } else if (tabName === 'rewards-tab' && currentPlayer) {
                loadRewards(currentPlayer);
            }
        }

        function logoutPlayer() {
            Auth.clearCurrentPlayerCode();
            window.location.href = 'player-access.html';
        }

        loadPlayerProfile();
    </script>
</body>
</html>